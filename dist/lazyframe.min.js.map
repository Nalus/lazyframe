{"version":3,"file":"lazyframe.min.js","sources":["../src/lazyframe.js"],"sourcesContent":["const Lazyframe = () => {\n\n  let settings;\n\n  const elements = [];\n\n  const defaults = {\n    vendor: undefined,\n    id: undefined,\n    src: undefined,\n    thumbnail: undefined,\n    title: undefined,\n    apikey: undefined,\n    initialized: false,\n    parameters: undefined,\n    y: undefined,\n    debounce: 250,\n    lazyload: true,\n    initinview: false,\n    onLoad: (l) => {},\n    onAppend: (l) => {},\n    onThumbnailLoad: (img) => {}\n  };\n\n  const constants = {\n    regex: {\n      youtube_nocookie: /(?:youtube-nocookie\\.com\\/\\S*(?:(?:\\/e(?:mbed))?\\/|watch\\?(?:\\S*?&?v\\=)))([a-zA-Z0-9_-]{6,11})/,\n      youtube: /(?:youtube\\.com\\/\\S*(?:(?:\\/e(?:mbed))?\\/|watch\\?(?:\\S*?&?v\\=))|youtu\\.be\\/)([a-zA-Z0-9_-]{6,11})/,\n      vimeo: /vimeo\\.com\\/(?:video\\/)?([0-9]*)(?:\\?|)/,\n      vine: /vine.co\\/v\\/(.*)/\n    },\n    condition: {\n      youtube: (m) => (m && m[1].length == 11) ? m[1] : false,\n      youtube_nocookie: (m) => (m && m[1].length == 11) ? m[1] : false,\n      vimeo: (m) => (m && m[1].length === 9 || m[1].length === 8) ? m[1] : false,\n      vine: (m) => (m && m[1].length === 11) ? m[1] : false\n    },\n    src: {\n      youtube: (s) => `https://www.youtube.com/embed/${s.id}/?${s.parameters}`,\n      youtube_nocookie: (s) => `https://www.youtube-nocookie.com/embed/${s.id}/?${s.parameters}`,\n      vimeo: (s) => `https://player.vimeo.com/video/${s.id}/?${s.parameters}`,\n      vine: (s) => `https://vine.co/v/${s.id}/embed/simple`\n    },\n    endpoints: {\n      youtube: (s) => `https://www.googleapis.com/youtube/v3/videos?id=${s.id}&key=${s.apikey}&fields=items(snippet(title,thumbnails))&part=snippet`,\n      youtube_nocookie: (s) => `https://www.googleapis.com/youtube/v3/videos?id=${s.id}&key=${s.apikey}&fields=items(snippet(title,thumbnails))&part=snippet`,\n      vimeo: (s) => `https://vimeo.com/api/oembed.json?url=https%3A//vimeo.com/${s.id}`,\n      vine: (s) => `https://vine.co/oembed.json?url=https%3A%2F%2Fvine.co%2Fv%2F${s.id}`\n    },\n    response: {\n      youtube: {\n        title: (r) => r.items['0'].snippet.title,\n        thumbnail: (r) => {\n          let thumbs = r.items[\"0\"].snippet.thumbnails;\n          let thumb = thumbs.maxres || thumbs.standard || thumbs.high || thumbs.medium || thumbs.default;\n          return thumb.url;\n        }\n      },\n      youtube_nocookie: {\n        title: (r) => r.items['0'].snippet.title,\n        thumbnail: (r) => {\n          let thumbs = r.items[\"0\"].snippet.thumbnails;\n          let thumb = thumbs.maxres || thumbs.standard || thumbs.high || thumbs.medium || thumbs.default;\n          return thumb.url;\n        }\n      },\n      vimeo: {\n        title: (r) => r.title,\n        thumbnail: (r) => r.thumbnail_url\n      },\n      vine: {\n        title: (r) => r.title,\n        thumbnail: (r) => r.thumbnail_url\n      }\n    }\n  };\n\n  function init(elements, ...args) {\n    settings = Object.assign({}, defaults, args[0]);\n\n    if (typeof elements === 'string') {\n\n      const selector = document.querySelectorAll(elements);\n      for (let i = 0; i < selector.length; i++) {\n        loop(selector[i]);\n      }\n\n    } else if (typeof elements.length === 'undefined'){\n      loop(elements);\n\n    } else if (elements.length > 1) {\n\n      for (let i = 0; i < elements.length; i++) {\n        loop(elements[i]);\n      }\n\n    } else {\n      loop(elements[0]);\n    }\n\n    if (settings.lazyload) {\n      scroll();\n    }\n\n  }\n\n  function loop(el) {\n\n    if(el instanceof HTMLElement === false ||\n       el.classList.contains('lazyframe--loaded')) return;\n\n    const lazyframe = {\n      el: el,\n      settings: setup(el),\n    };\n\n    lazyframe.el.addEventListener('click', () => {\n      lazyframe.el.appendChild(lazyframe.iframe);\n\n      const iframe = el.querySelectorAll('iframe');\n      lazyframe.settings.onAppend.call(this, iframe[0]);\n    });\n\n    if (settings.lazyload) {\n      build(lazyframe);\n    } else {\n      api(lazyframe, !!lazyframe.settings.thumbnail);\n    }\n\n  }\n\n  function setup(el) {\n\n    const attr = Array.prototype.slice.apply(el.attributes)\n     .filter(att => att.value !== '')\n     .reduce((obj, curr) => {\n        let name = curr.name.indexOf('data-') === 0 ? curr.name.split('data-')[1] : curr.name;\n        obj[name] = curr.value;\n        return obj;\n     }, {});\n\n    const options = Object.assign({},\n      settings,\n      attr,\n      {\n        y: el.offsetTop,\n        parameters: extractParams(attr.src)\n      }\n    );\n\n    if (options.vendor) {\n      const match = options.src.match(constants.regex[options.vendor]);\n      options.id = constants.condition[options.vendor](match);\n    }\n\n    return options;\n\n  }\n\n  function extractParams(url) {\n    let params = url.split('?');\n\n    if (params[1]) {\n      params = params[1];\n      const hasAutoplay = params.indexOf('autoplay') !== -1;\n      return hasAutoplay ? params : params + '&autoplay=1';\n\n    } else {\n      return 'autoplay=1';\n    }\n\n  }\n\n  function useApi(settings) {\n\n    if (!settings.vendor) return false;\n\n    if (!settings.title || !settings.thumbnail) {\n      if (settings.vendor === 'youtube' || settings.vendor === 'youtube_nocookie') {\n        return !!settings.apikey;\n      } else {\n        return true;\n      }\n\n    } else {\n      return false;\n    }\n\n  }\n\n  function api(lazyframe) {\n\n    if (useApi(lazyframe.settings)) {\n      send(lazyframe, (err, data) => {\n        if (err) return;\n\n        const response = data[0];\n        const _l = data[1];\n\n        if (!_l.settings.title) {\n          _l.settings.title = constants.response[_l.settings.vendor].title(response);\n        }\n        if (!_l.settings.thumbnail) {\n          const url = constants.response[_l.settings.vendor].thumbnail(response);\n          _l.settings.thumbnail = url;\n          lazyframe.settings.onThumbnailLoad.call(this, url);\n        }\n        build(_l, true);\n\n      });\n\n    }else{\n      build(lazyframe, true);\n    }\n\n  }\n\n  function send(lazyframe, cb) {\n\n    const endpoint = constants.endpoints[lazyframe.settings.vendor](lazyframe.settings);\n    const request = new XMLHttpRequest();\n\n    request.open('GET', endpoint, true);\n\n    request.onload = function() {\n      if (request.status >= 200 && request.status < 400) {\n        const data = JSON.parse(request.responseText);\n        cb(null, [data, lazyframe]);\n      } else {\n        cb(true);\n      }\n    };\n\n    request.onerror = function() {\n      cb(true);\n    };\n\n    request.send();\n\n  }\n\n  function scroll() {\n\n    const height = window.innerHeight;\n    let count = elements.length;\n    const initElement = (el, i) => {\n      el.settings.initialized = true;\n      el.el.classList.add('lazyframe--loaded');\n      count--;\n      api(el);\n\n      if (el.settings.initinview) {\n        el.el.click();\n      }\n\n      el.settings.onLoad.call(this, el);\n    }\n\n    elements\n      .filter(el => el.settings.y < height)\n      .forEach(initElement);\n\n    const onScroll = debounce(() => {\n\n      up = lastY < window.pageYOffset;\n      lastY = window.pageYOffset;\n\n      if (up) {\n        elements\n          .filter(el => el.settings.y < (height + lastY) && el.settings.initialized === false)\n          .forEach(initElement);\n      }\n\n      if (count === 0) {\n        window.removeEventListener('scroll', onScroll, false);\n      }\n\n    }, settings.debounce);\n\n    let lastY = 0;\n    let t = false, up = false;\n    window.addEventListener('scroll', onScroll, false);\n\n    function debounce(func, wait, immediate) {\n      let timeout;\n      return function() {\n        let context = this, args = arguments;\n        let later = function() {\n          timeout = null;\n          if (!immediate) func.apply(context, args);\n        };\n        let callNow = immediate && !timeout;\n        clearTimeout(timeout);\n        timeout = setTimeout(later, wait);\n        if (callNow) func.apply(context, args);\n      };\n    };\n\n  }\n\n  function build(lazyframe, loadImage) {\n\n    lazyframe.iframe = getIframe(lazyframe.settings);\n\n    if (lazyframe.settings.thumbnail && loadImage) {\n      lazyframe.el.style.backgroundImage = `url(${lazyframe.settings.thumbnail})`;\n    }\n\n    if (lazyframe.settings.title && lazyframe.el.children.length === 0) {\n      const docfrag = document.createDocumentFragment(),\n            titleNode = document.createElement('span');\n\n      titleNode.className = 'lazyframe__title';\n      titleNode.innerHTML = lazyframe.settings.title;\n      docfrag.appendChild(titleNode);\n\n      lazyframe.el.appendChild(docfrag);\n    }\n\n    if (!settings.lazyload) {\n      lazyframe.el.classList.add('lazyframe--loaded');\n      lazyframe.settings.onLoad.call(this, lazyframe);\n      elements.push(lazyframe);\n    }\n\n    if (!lazyframe.settings.initialized) {\n      elements.push(lazyframe);\n    }\n\n  }\n\n  function getIframe(settings) {\n\n    const docfrag = document.createDocumentFragment(),\n          iframeNode = document.createElement('iframe');\n\n    if (settings.vendor) {\n      settings.src = constants.src[settings.vendor](settings);\n    }\n\n    iframeNode.setAttribute('id', `lazyframe-${settings.id}`);\n    iframeNode.setAttribute('src', settings.src);\n    iframeNode.setAttribute('frameborder', 0);\n    iframeNode.setAttribute('allowfullscreen', '');\n\n    if (settings.vendor === 'vine') {\n      const scriptNode = document.createElement('script');\n      scriptNode.setAttribute('src', 'https://platform.vine.co/static/scripts/embed.js');\n      docfrag.appendChild(scriptNode);\n    }\n\n    docfrag.appendChild(iframeNode);\n    return docfrag;\n\n  }\n\n  return init;\n\n}\n\nconst lf = Lazyframe();\n\nexport default lf;\n"],"names":["settings","elements","defaults","constants","loop","el","lazyframe","HTMLElement","classList","contains","attr","Array","prototype","slice","apply","attributes","filter","att","value","reduce","obj","curr","name","indexOf","split","options","_extends","y","offsetTop","parameters","url","params","extractParams","src","vendor","match","regex","id","condition","setup","addEventListener","appendChild","iframe","querySelectorAll","onAppend","call","_this","lazyload","build","api","thumbnail","cb","request","title","apikey","err","data","response","_l","onThumbnailLoad","_this2","endpoint","endpoints","XMLHttpRequest","open","onload","status","JSON","parse","responseText","onerror","send","loadImage","docfrag","document","createDocumentFragment","iframeNode","createElement","setAttribute","scriptNode","getIframe","style","backgroundImage","children","length","titleNode","className","innerHTML","add","onLoad","this","push","initialized","undefined","debounce","initinview","l","img","youtube_nocookie","youtube","vimeo","vine","m","s","r","items","snippet","thumbs","thumbnails","maxres","standard","high","medium","thumbnail_url","selector","i","initElement","count","click","_this3","height","window","innerHeight","forEach","onScroll","func","wait","immediate","timeout","context","args","arguments","callNow","clearTimeout","setTimeout","up","lastY","pageYOffset","removeEventListener","scroll"],"mappings":"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"}