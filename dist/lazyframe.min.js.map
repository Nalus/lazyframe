{"version":3,"file":"lazyframe.min.js","sources":["../src/lazyframe.js"],"sourcesContent":["const Lazyframe = () => {\n\n  let settings;\n\n  const elements = [];\n\n  const defaults = {\n    vendor: undefined,\n    id: undefined,\n    src: undefined,\n    thumbnail: undefined,\n    title: undefined,\n    apikey: undefined,\n    initialized: false,\n    parameters: undefined,\n    y: undefined,\n    debounce: 250,\n    lazyload: true,\n    autoplay: true,\n    initinview: false,\n    onLoad: (l) => {},\n    onAppend: (l) => {},\n    onThumbnailLoad: (img) => {}\n  };\n\n  const constants = {\n    regex: {\n      youtube_nocookie: /(?:youtube-nocookie\\.com\\/\\S*(?:(?:\\/e(?:mbed))?\\/|watch\\?(?:\\S*?&?v\\=)))([a-zA-Z0-9_-]{6,11})/,\n      youtube: /(?:youtube\\.com\\/\\S*(?:(?:\\/e(?:mbed))?\\/|watch\\?(?:\\S*?&?v\\=))|youtu\\.be\\/)([a-zA-Z0-9_-]{6,11})/,\n      vimeo: /vimeo\\.com\\/(?:video\\/)?([0-9]*)(?:\\?|)/\n    },\n    condition: {\n      youtube: (m) => (m && m[1].length == 11) ? m[1] : false,\n      youtube_nocookie: (m) => (m && m[1].length == 11) ? m[1] : false,\n      vimeo: (m) => (m && m[1].length === 9 || m[1].length === 8) ? m[1] : false,\n    },\n    src: {\n      youtube: (s) => `https://www.youtube.com/embed/${s.id}/?${s.parameters}`,\n      youtube_nocookie: (s) => `https://www.youtube-nocookie.com/embed/${s.id}/?${s.parameters}`,\n      vimeo: (s) => `https://player.vimeo.com/video/${s.id}/?${s.parameters}`,\n    },\n    endpoints: {\n      youtube: (s) => `https://www.googleapis.com/youtube/v3/videos?id=${s.id}&key=${s.apikey}&fields=items(snippet(title,thumbnails))&part=snippet`,\n      youtube_nocookie: (s) => `https://www.googleapis.com/youtube/v3/videos?id=${s.id}&key=${s.apikey}&fields=items(snippet(title,thumbnails))&part=snippet`,\n      vimeo: (s) => `https://vimeo.com/api/oembed.json?url=https%3A//vimeo.com/${s.id}`,\n    },\n    response: {\n      youtube: {\n        title: (r) => r.items['0'].snippet.title,\n        thumbnail: (r) => {\n          let thumbs = r.items[\"0\"].snippet.thumbnails;\n          let thumb = thumbs.maxres || thumbs.standard || thumbs.high || thumbs.medium || thumbs.default;\n          return thumb.url;\n        }\n      },\n      youtube_nocookie: {\n        title: (r) => r.items['0'].snippet.title,\n        thumbnail: (r) => {\n          let thumbs = r.items[\"0\"].snippet.thumbnails;\n          let thumb = thumbs.maxres || thumbs.standard || thumbs.high || thumbs.medium || thumbs.default;\n          return thumb.url;\n        }\n      },\n      vimeo: {\n        title: (r) => r.title,\n        thumbnail: (r) => r.thumbnail_url\n      }\n    }\n  };\n\n  function init(elements, ...args) {\n    settings = Object.assign({}, defaults, args[0]);\n\n    if (typeof elements === 'string') {\n\n      const selector = document.querySelectorAll(elements);\n      for (let i = 0; i < selector.length; i++) {\n        loop(selector[i]);\n      }\n\n    } else if (typeof elements.length === 'undefined'){\n      loop(elements);\n\n    } else if (elements.length > 1) {\n\n      for (let i = 0; i < elements.length; i++) {\n        loop(elements[i]);\n      }\n\n    } else {\n      loop(elements[0]);\n    }\n\n    if (settings.lazyload) {\n      scroll();\n    }\n\n  }\n\n  function loop(el) {\n\n    if(el instanceof HTMLElement === false ||\n       el.classList.contains('lazyframe--loaded')) return;\n\n    const lazyframe = {\n      el: el,\n      settings: setup(el),\n    };\n\n    lazyframe.el.addEventListener('click', () => {\n      lazyframe.el.appendChild(lazyframe.iframe);\n\n      const iframe = el.querySelectorAll('iframe');\n      lazyframe.settings.onAppend.call(this, iframe[0]);\n    });\n\n    if (settings.lazyload) {\n      build(lazyframe);\n    } else {\n      api(lazyframe, !!lazyframe.settings.thumbnail);\n    }\n\n  }\n\n  function setup(el) {\n\n    const attr = Array.prototype.slice.apply(el.attributes)\n     .filter(att => att.value !== '')\n     .reduce((obj, curr) => {\n        let name = curr.name.indexOf('data-') === 0 ? curr.name.split('data-')[1] : curr.name;\n        obj[name] = curr.value;\n        return obj;\n     }, {});\n\n    const options = Object.assign({},\n      settings,\n      attr,\n      {\n        y: el.offsetTop,\n        parameters: extractParams(attr.src)\n      }\n    );\n\n    if (options.vendor) {\n      const match = options.src.match(constants.regex[options.vendor]);\n      options.id = constants.condition[options.vendor](match);\n    }\n\n    return options;\n\n  }\n\n  function extractParams(url) {\n    let params = url.split('?');\n\n    if (params[1]) {\n      params = params[1];\n      const hasAutoplay = params.indexOf('autoplay') !== -1;\n      return hasAutoplay ? params : params + '&autoplay=1';\n\n    } else {\n      return 'autoplay=1';\n    }\n\n  }\n\n  function useApi(settings) {\n\n    if (!settings.vendor) return false;\n\n    if (!settings.title || !settings.thumbnail) {\n      if (settings.vendor === 'youtube' || settings.vendor === 'youtube_nocookie') {\n        return !!settings.apikey;\n      } else {\n        return true;\n      }\n\n    } else {\n      return false;\n    }\n\n  }\n\n  function api(lazyframe) {\n\n    if (useApi(lazyframe.settings)) {\n      send(lazyframe, (err, data) => {\n        if (err) return;\n\n        const response = data[0];\n        const _l = data[1];\n\n        if (!_l.settings.title) {\n          _l.settings.title = constants.response[_l.settings.vendor].title(response);\n        }\n        if (!_l.settings.thumbnail) {\n          const url = constants.response[_l.settings.vendor].thumbnail(response);\n          _l.settings.thumbnail = url;\n          lazyframe.settings.onThumbnailLoad.call(this, url);\n        }\n        build(_l, true);\n\n      });\n\n    }else{\n      build(lazyframe, true);\n    }\n\n  }\n\n  function send(lazyframe, cb) {\n\n    const endpoint = constants.endpoints[lazyframe.settings.vendor](lazyframe.settings);\n    const request = new XMLHttpRequest();\n\n    request.open('GET', endpoint, true);\n\n    request.onload = function() {\n      if (request.status >= 200 && request.status < 400) {\n        const data = JSON.parse(request.responseText);\n        cb(null, [data, lazyframe]);\n      } else {\n        cb(true);\n      }\n    };\n\n    request.onerror = function() {\n      cb(true);\n    };\n\n    request.send();\n\n  }\n\n  function scroll() {\n\n    const height = window.innerHeight;\n    let count = elements.length;\n    const initElement = (el, i) => {\n      el.settings.initialized = true;\n      el.el.classList.add('lazyframe--loaded');\n      count--;\n      api(el);\n\n      if (el.settings.initinview) {\n        el.el.click();\n      }\n\n      el.settings.onLoad.call(this, el);\n    }\n\n    elements\n      .filter(el => el.settings.y < height)\n      .forEach(initElement);\n\n    const onScroll = debounce(() => {\n\n      up = lastY < window.pageYOffset;\n      lastY = window.pageYOffset;\n\n      if (up) {\n        elements\n          .filter(el => el.settings.y < (height + lastY) && el.settings.initialized === false)\n          .forEach(initElement);\n      }\n\n      if (count === 0) {\n        window.removeEventListener('scroll', onScroll, false);\n      }\n\n    }, settings.debounce);\n\n    let lastY = 0;\n    let t = false, up = false;\n    window.addEventListener('scroll', onScroll, false);\n\n    function debounce(func, wait, immediate) {\n      let timeout;\n      return function() {\n        let context = this, args = arguments;\n        let later = function() {\n          timeout = null;\n          if (!immediate) func.apply(context, args);\n        };\n        let callNow = immediate && !timeout;\n        clearTimeout(timeout);\n        timeout = setTimeout(later, wait);\n        if (callNow) func.apply(context, args);\n      };\n    };\n\n  }\n\n  function build(lazyframe, loadImage) {\n\n    lazyframe.iframe = getIframe(lazyframe.settings);\n\n    if (lazyframe.settings.thumbnail && loadImage) {\n      lazyframe.el.style.backgroundImage = `url(${lazyframe.settings.thumbnail})`;\n    }\n\n    if (lazyframe.settings.title && lazyframe.el.children.length === 0) {\n      const docfrag = document.createDocumentFragment(),\n            titleNode = document.createElement('span');\n\n      titleNode.className = 'lazyframe__title';\n      titleNode.innerHTML = lazyframe.settings.title;\n      docfrag.appendChild(titleNode);\n\n      lazyframe.el.appendChild(docfrag);\n    }\n\n    if (!settings.lazyload) {\n      lazyframe.el.classList.add('lazyframe--loaded');\n      lazyframe.settings.onLoad.call(this, lazyframe);\n      elements.push(lazyframe);\n    }\n\n    if (!lazyframe.settings.initialized) {\n      elements.push(lazyframe);\n    }\n\n  }\n\n  function getIframe(settings) {\n\n    const docfrag = document.createDocumentFragment(),\n          iframeNode = document.createElement('iframe');\n\n    if (settings.vendor) {\n      settings.src = constants.src[settings.vendor](settings);\n    }\n\n    iframeNode.setAttribute('id', `lazyframe-${settings.id}`);\n    iframeNode.setAttribute('src', settings.src);\n    iframeNode.setAttribute('frameborder', 0);\n    iframeNode.setAttribute('allowfullscreen', '');\n    \n    if (settings.autoplay) {\n      iframeNode.allow = 'accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture';\n    }\n\n    docfrag.appendChild(iframeNode);\n    return docfrag;\n\n  }\n\n  return init;\n\n}\n\nconst lf = Lazyframe();\n\nexport default lf;\n"],"names":["settings","elements","defaults","vendor","undefined","id","src","thumbnail","title","apikey","initialized","parameters","y","debounce","lazyload","autoplay","initinview","onLoad","l","onAppend","onThumbnailLoad","img","constants","regex","youtube_nocookie","youtube","vimeo","condition","m","length","s","endpoints","response","r","items","snippet","thumbs","thumbnails","maxres","standard","high","medium","url","thumbnail_url","loop","el","HTMLElement","classList","contains","lazyframe","setup","addEventListener","appendChild","iframe","querySelectorAll","call","_this","build","api","attr","Array","prototype","slice","apply","attributes","filter","att","value","reduce","obj","curr","name","indexOf","split","options","_extends","offsetTop","extractParams","match","params","useApi","cb","endpoint","request","XMLHttpRequest","open","onload","status","data","JSON","parse","responseText","onerror","send","err","_l","_this2","scroll","height","window","innerHeight","count","initElement","i","add","click","_this3","forEach","func","wait","immediate","timeout","onScroll","up","lastY","pageYOffset","removeEventListener","context","this","args","arguments","later","callNow","clearTimeout","setTimeout","loadImage","docfrag","document","createDocumentFragment","iframeNode","createElement","setAttribute","allow","getIframe","style","backgroundImage","children","titleNode","className","innerHTML","push","selector","Lazyframe"],"mappings":"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"}